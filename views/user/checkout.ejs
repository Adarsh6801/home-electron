<%- include('./partials/userHeader.ejs') %>

    <style>
        .checkbox-xl .form-check-input {
            top: 1.2rem;
            scale: 1.7;
            margin-right: 0.8rem;

        }

        .checkbox-xl .form-check-label {
            padding-top: 19px;
        }
    </style>


    <!-- Checkout Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-8">
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Billing
                        Address</span></h5>
                <div class="bg-light p-30 mb-5">
                    <div class="row">
                        <% userAddress.Address.forEach(function(x,index){ %>
                            <div class="col-md-6 col-xl-4">

                                <div class="card bg-info text-white mb-3">
                                    <div class="form-check checkbox-xl ml-auto ">
                                        <input class="form-check-input" type="radio" checked value="<%= index%>"
                                            name="id" id="address">

                                    </div>
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-white">
                                            <%= x.firstName%>
                                                <%= x.lastName%>
                                        </h5>
                                        <p style="font-size: 0.75rem;" class="align-middle text-dark font-weight-bold">
                                            <%= x.mobileNo%>
                                        </p>
                                        <p style="font-size: 0.9rem;" class="align-middle text-dark font-weight-bold">
                                            <%= x.address%>
                                        </p>
                                        <p style="font-size: 0.9rem;" class="align-middle text-dark font-weight-bold">
                                            <%= x.landmark%>,<%= x.locality%>
                                        </p>
                                        <p style="font-size: 0.9rem;" class="align-middle text-dark font-weight-bold">
                                            <%= x.city%>
                                        </p>
                                        <p style="font-size: 0.76rem;" class="align-middle text-dark font-weight-bold">
                                            ( <%= x.pinCode%>)</p>

                                    </div>
                                </div>

                            </div>
                            <% }) %>
                                <div class="col-md-12">
                                    <p>Create New Address</p>
                                    <button type="button" class="btn btn-primary ml-4" data-toggle="modal"
                                        data-target="#exampleModalCenter">
                                        Add
                                    </button>
                                </div>
                    </div>
                </div>
                <div class="collapse mb-5" id="shipping-address">



                </div>
            </div>




            <div class="col-lg-4">
                <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Order
                        Total</span></h5>
                <div class="bg-light p-30 mb-5">
                    <div class="border-bottom">
                        <h6 class="mb-3">Products</h6>
                        <% cartView.products.forEach((p)=> { %>

                            <div class="d-flex justify-content-between">
                                <p>
                                    <%=p.name%>
                                </p>
                                <p>
                                    <%=p.quantity%>
                                </p>
                                <p>
                                    <%=p.quantity*p.price%>
                                </p>
                            </div>
                            <% }) %>
                    </div>
                    <div class="border-bottom pt-3 pb-2">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Subtotal</h6>
                            <h6>
                                <%=cartView.total%>
                            </h6>
                        </div>


                    </div>
                    <div class="pt-2">
                        <div class="d-flex justify-content-between mt-2">
                            <h5>Total</h5>
                            <h5>
                                <%=cartView.total%>
                            </h5>
                        </div>
                    </div>
                </div>








                <form action="" id="place-order">
                    <div class="mb-5">
                        <h5 class="section-title position-relative text-uppercase mb-3"><span
                                class="bg-secondary pr-3">Payment</span></h5>
                        <div class="bg-light p-30">
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="payment" id="paypal"
                                        value="cash on delivery">
                                    <label class="custom-control-label" for="paypal">COD</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="payment" id="directcheck"
                                        value="online payment">
                                    <label class="custom-control-label" for="directcheck">UPI</label>
                                </div>
                            </div>
                            <input type="submit" class="btn btn-block btn-primary font-weight-bold py-3"
                                value="Place Order">
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>

    <!-- ---------------------------------------------------------Modal--------------------------------------------------------------- -->
    <div class="modal fade" id="exampleModalCenter" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Add Address</h1>
                </div>
                <div class="modal-body">
                    <form action="/addAddress" method="post">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>First Name</label>
                                <input class="form-control" type="text" value="" name="firstName">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Last Name</label>
                                <input class="form-control" type="text" value="" name="lastName">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Mobile No</label>
                                <input class="form-control" type="text" value="" name="mobileNo">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Address Line</label>
                                <input class="form-control" type="text" value="" name="address">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>City</label>
                                <input class="form-control" type="text" value="" name="city">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Locality</label>
                                <input class="form-control" type="text" value="" name="locality">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Landmark</label>
                                <input class="form-control" type="text" value="" name="landmark">
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Pin Code</label>
                                <input class="form-control" type="text" value="" name="pinCode">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary font-weight-bold">Add
                                    Address</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
   
    <script>
        $("#place-order").submit((e) => {
            e.preventDefault()
            let selectedAddress
            let addresses = document.querySelectorAll('input[name="id"]')

            for (address of addresses) {
                if (address.checked) {
                    selectedAddress = address.value
                    break
                }
            }
            console.log(selectedAddress)
            $.ajax({
                url: '/user_order',
                method: 'post',
                data: $('#place-order').serialize() + "&id=" + selectedAddress,
                success: (response) => {
                    //    alert('response')
                    if (response.codSuccess) {
                        console.log('this is worked');
                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Order Success',
                            customClass: 'swal-wide',
                            showConfirmButton: false,
                            timer: 1000
                        }).then((result) => {
                            location.href = '/order_success'
                        })
                    } else {
                        if (response.order == null) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Connection Failed',
                                text: 'Please Check the Internet Connection!',
                                customClass: 'swal-wide',
                            })
                        } else {
                            razorpayPayment(response)
                        }
                    }
                }
            })

        })
        function razorpayPayment(Payment) {
            var options = {
                "key": "rzp_test_filNO2IPOu8MkQ", // Enter the Key ID generated from the Dashboard
                "amount": Payment.order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                "currency": "INR",
                "name": "Home Electron ",
                "description": "Complete Your Transaction",
                "image": "",
                "order_id": Payment.order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                "handler": function (response) {
                    verifyPayment(response, Payment.order)
                },
                "prefill": {
                    "name": Payment.userOrder.Address.firstName + " " + Payment.userOrder.Address.lastName,
                    "email": Payment.User.email,
                    "contact": Payment.userOrder.Address.mobileNo
                },
                "notes": {
                    "address": "Home electron Choose your electric Best for Home"
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        }

       function verifyPayment(payment, order) {
            $.ajax({
                url: '/verify_payment',
                data: {
                    payment: payment,
                    orders: order
                },
                method: 'post',
                success: (response) => {
                    if (response.status) {
                        Swal.fire({
                            position: 'center',
                            icon: 'success',
                            title: 'Payment Success',
                            showConfirmButton: false,
                            customClass: 'swal-wide',
                            timer: 1000
                        }).then((result) => {
                            location.href = '/order_success'
                        })
                    } else {
                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Payment Failed',
                            showConfirmButton: false,
                            customClass: 'swal-wide',
                            timer: 1000
                        }).then((result) => {
                            location.reload()
                        })
                    }
                }
            })
        }


    </script>

    <%- include('./partials/userFooter.ejs') %>